var $=Object.defineProperty,K=Object.defineProperties;var Y=Object.getOwnPropertyDescriptors;var g=Object.getOwnPropertySymbols;var B=Object.prototype.hasOwnProperty,H=Object.prototype.propertyIsEnumerable;var M=(t,a,u)=>a in t?$(t,a,{enumerable:!0,configurable:!0,writable:!0,value:u}):t[a]=u,C=(t,a)=>{for(var u in a||(a={}))B.call(a,u)&&M(t,u,a[u]);if(g)for(var u of g(a))H.call(a,u)&&M(t,u,a[u]);return t},h=(t,a)=>K(t,Y(a));import{r as p,a as J}from"./index.12980c00.js";import{f as L}from"./fdb2e11a.js";import{u as W,C as X,a as Z,b as F,c as tt,d as et,e as rt,f as at,g as it,h as st,i as dt}from"./004862cd.js";import{C as ct}from"./8a56554b.js";import{b as ut}from"./eb35c225.js";import"./55bbc67b.js";import{C as f}from"./753dd0ff.js";import"./4f9f6ebd.js";import"./17dc894b.js";import"./692be0fa.js";import"./65902cd8.js";const q="shopifyCartId";function ot(t,a){switch(a.type){case"cartFetch":{if(t.status==="uninitialized")return{status:"fetching"};break}case"cartCreate":{if(t.status==="uninitialized")return{status:"creating"};break}case"resolve":{if(["updating","fetching","creating"].includes(t.status))return{status:"idle",cart:a.cart};break}case"reject":{if(t.status==="fetching"||t.status==="creating")return{status:"uninitialized",error:a.error};if(t.status==="updating")return{status:"idle",cart:t.lastValidCart,error:a.error};break}case"resetCart":{if(t.status==="fetching")return{status:"uninitialized"};break}case"addLineItem":{if(t.status==="idle")return{status:"updating",cart:t.cart,lastValidCart:t.cart};break}case"removeLineItem":{if(t.status==="idle")return{status:"updating",cart:h(C({},t.cart),{lines:t.cart.lines.filter(({id:u})=>!a.lines.includes(u))}),lastValidCart:t.cart};break}case"updateLineItem":{if(t.status==="idle")return{status:"updating",cart:h(C({},t.cart),{lines:t.cart.lines.map(u=>{const b=a.lines.find(({id:I})=>I===u.id);return b&&b.quantity?h(C({},u),{quantity:b.quantity}):u})}),lastValidCart:t.cart};break}case"noteUpdate":{if(t.status==="idle")return{status:"updating",cart:t.cart,lastValidCart:t.cart};break}case"buyerIdentityUpdate":{if(t.status==="idle")return{status:"updating",cart:t.cart,lastValidCart:t.cart};break}case"cartAttributesUpdate":{if(t.status==="idle")return{status:"updating",cart:t.cart,lastValidCart:t.cart};break}case"discountCodesUpdate":{if(t.status==="idle")return{status:"updating",cart:t.cart,lastValidCart:t.cart};break}}throw new Error(`Cannot dispatch event (${a.type}) for current cart state (${t.status})`)}function Ut({children:t,numCartLines:a,onCreate:u,onLineAdd:b,onLineRemove:I,onLineUpdate:k,onNoteUpdate:U,onBuyerIdentityUpdate:x,onAttributesUpdate:A,onDiscountCodesUpdate:w,data:_,cartFragment:n=dt}){var R;const{serverProps:D}=ut(),o=(R=D==null?void 0:D.country)===null||R===void 0?void 0:R.isoCode,Q=_?{status:"idle",cart:y(_)}:{status:"uninitialized"},[l,d]=p.exports.useReducer((e,i)=>ot(e,i),Q),v=W(),m=p.exports.useCallback(async e=>{d({type:"cartFetch"});const{data:i}=await v({query:X(n),variables:{id:e,numCartLines:a,country:o}});if(!(i!=null&&i.cart)){window.localStorage.removeItem(q),d({type:"resetCart"});return}d({type:"resolve",cart:y(i.cart)})},[v,n,a,o]),T=p.exports.useCallback(async e=>{var i,s;d({type:"cartCreate"}),u==null||u(),o&&!(!((i=e.buyerIdentity)===null||i===void 0)&&i.countryCode)&&(e.buyerIdentity==null&&(e.buyerIdentity={}),e.buyerIdentity.countryCode=o);const{data:r,error:c}=await v({query:Z(n),variables:{input:e,numCartLines:a,country:o}});c&&d({type:"reject",error:c}),!((s=r==null?void 0:r.cartCreate)===null||s===void 0)&&s.cart&&(e.lines&&f.publish(f.eventNames.ADD_TO_CART,!0,{addedCartLines:e.lines,cart:r.cartCreate.cart}),d({type:"resolve",cart:y(r.cartCreate.cart)}),window.localStorage.setItem(q,r.cartCreate.cart.id))},[u,o,v,n,a]),E=p.exports.useCallback(async(e,i)=>{var s;if(i.status==="idle"){d({type:"addLineItem"}),b==null||b();const{data:r,error:c}=await v({query:F(n),variables:{cartId:i.cart.id,lines:e,numCartLines:a,country:o}});c&&d({type:"reject",error:c}),!((s=r==null?void 0:r.cartLinesAdd)===null||s===void 0)&&s.cart&&(f.publish(f.eventNames.ADD_TO_CART,!0,{addedCartLines:e,cart:r.cartLinesAdd.cart}),d({type:"resolve",cart:y(r.cartLinesAdd.cart)}))}},[b,v,n,a,o]),S=p.exports.useCallback(async(e,i)=>{var s;if(i.status==="idle"){d({type:"removeLineItem",lines:e}),I==null||I();const{data:r,error:c}=await v({query:tt(n),variables:{cartId:i.cart.id,lines:e,numCartLines:a,country:o}});c&&d({type:"reject",error:c}),!((s=r==null?void 0:r.cartLinesRemove)===null||s===void 0)&&s.cart&&(f.publish(f.eventNames.REMOVE_FROM_CART,!0,{removedCartLines:e,cart:r.cartLinesRemove.cart}),d({type:"resolve",cart:y(r.cartLinesRemove.cart)}))}},[I,v,n,a,o]),V=p.exports.useCallback(async(e,i)=>{var s;if(i.status==="idle"){d({type:"updateLineItem",lines:e}),k==null||k();const{data:r,error:c}=await v({query:et(n),variables:{cartId:i.cart.id,lines:e,numCartLines:a,country:o}});c&&d({type:"reject",error:c}),!((s=r==null?void 0:r.cartLinesUpdate)===null||s===void 0)&&s.cart&&(f.publish(f.eventNames.UPDATE_CART,!0,{updatedCartLines:e,oldCart:i.cart}),d({type:"resolve",cart:y(r.cartLinesUpdate.cart)}))}},[k,v,n,a,o]),O=p.exports.useCallback(async(e,i)=>{var s;if(i.status==="idle"){d({type:"noteUpdate"}),U==null||U();const{data:r,error:c}=await v({query:rt(n),variables:{cartId:i.cart.id,note:e,numCartLines:a,country:o}});c&&d({type:"reject",error:c}),!((s=r==null?void 0:r.cartNoteUpdate)===null||s===void 0)&&s.cart&&d({type:"resolve",cart:y(r.cartNoteUpdate.cart)})}},[U,v,n,a,o]),j=p.exports.useCallback(async(e,i)=>{var s;if(i.status==="idle"){d({type:"buyerIdentityUpdate"}),x==null||x();const{data:r,error:c}=await v({query:at(n),variables:{cartId:i.cart.id,buyerIdentity:e,numCartLines:a,country:o}});c&&d({type:"reject",error:c}),!((s=r==null?void 0:r.cartBuyerIdentityUpdate)===null||s===void 0)&&s.cart&&d({type:"resolve",cart:y(r.cartBuyerIdentityUpdate.cart)})}},[x,v,n,a,o]),z=p.exports.useCallback(async(e,i)=>{var s;if(i.status==="idle"){d({type:"cartAttributesUpdate"}),A==null||A();const{data:r,error:c}=await v({query:it(n),variables:{cartId:i.cart.id,attributes:e,numCartLines:a,country:o}});c&&d({type:"reject",error:c}),!((s=r==null?void 0:r.cartAttributesUpdate)===null||s===void 0)&&s.cart&&d({type:"resolve",cart:y(r.cartAttributesUpdate.cart)})}},[A,v,n,a,o]),N=p.exports.useCallback(async(e,i)=>{var s;if(i.status==="idle"){d({type:"discountCodesUpdate"}),w==null||w();const{data:r,error:c}=await v({query:st(n),variables:{cartId:i.cart.id,discountCodes:e,numCartLines:a,country:o}});c&&d({type:"reject",error:c}),!((s=r==null?void 0:r.cartDiscountCodesUpdate)===null||s===void 0)&&s.cart&&(f.publish(f.eventNames.DISCOUNT_CODE_UPDATED,!0,{updatedDiscountCodes:e,cart:r.cartDiscountCodesUpdate.cart}),d({type:"resolve",cart:y(r.cartDiscountCodesUpdate.cart)}))}},[w,v,n,a,o]),P=p.exports.useRef(!1);p.exports.useEffect(()=>{localStorage.getItem(q)&&l.status==="uninitialized"&&!P.current&&(P.current=!0,m(localStorage.getItem(q)))},[m,l]),p.exports.useEffect(()=>{l.status==="idle"&&j({countryCode:o},l)},[o]);const G=p.exports.useMemo(()=>h(C({},"cart"in l?l.cart:C({lines:[],attributes:[]},_?y(_):{})),{status:l.status,error:"error"in l?l.error:void 0,totalQuantity:"cart"in l?l.cart.lines.reduce((e,i)=>e+i.quantity,0):0,cartCreate:T,linesAdd(e){"cart"in l&&l.cart.id?E(e,l):T({lines:e})},linesRemove(e){S(e,l)},linesUpdate(e){V(e,l)},noteUpdate(e){O(e,l)},buyerIdentityUpdate(e){j(e,l)},cartAttributesUpdate(e){z(e,l)},discountCodesUpdate(e){N(e,l)},cartFragment:n}),[l,_,T,n,E,S,V,O,j,z,N]);return J(ct.Provider,{value:G,children:t})}function y(t){var a;return h(C({},t),{lines:L(t.lines),note:(a=t.note)!==null&&a!==void 0?a:void 0})}export{Ut as CartProvider};
//# sourceMappingURL=763e0627.js.map
